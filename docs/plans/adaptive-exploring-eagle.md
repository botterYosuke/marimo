# グリッドレイアウトでビジュアルアウトプットを自動配置する機能

## ステータス: ✅ 完成

**最終更新:** 2026-01-27

---

## 概要

`width="grid"`モードのノートブックで、チャート・画像・動画などのビジュアルアウトプットを自動的にグリッドに配置する機能。

従来はすべてのセル出力がサイドバー（Outputsパネル）に配置され、ユーザーが手動でドラッグしてグリッドに配置する必要があった。この機能により、ビジュアル出力は自動的に適切な位置・サイズでグリッドに配置される。

---

## 実装サマリー

### 新規作成ファイル

| ファイル | 説明 |
|---------|------|
| `frontend/src/core/layout/visual-output-detector.ts` | ビジュアルアウトプット判定ユーティリティ |
| `frontend/src/core/layout/auto-placement.ts` | グリッド配置位置計算アルゴリズム |
| `frontend/src/core/layout/__tests__/visual-output-detector.test.ts` | テスト（29ケース） |
| `frontend/src/core/layout/__tests__/auto-placement.test.ts` | テスト（12ケース） |
| `frontend/src/core/layout/__tests__/layout.test.ts` | テスト（9ケース） |

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `frontend/src/core/layout/layout.ts` | `autoLayoutEnabled`/`layoutWasAutoGenerated`状態追加、`addCellToGridLayout()`/`isCellInGrid()`関数追加、グリッド未初期化時の自動初期化 |
| `frontend/src/core/kernel/handlers.ts` | `autoPlaceVisualOutput()`関数追加、セル出力到着時に自動配置トリガー |

### テスト結果

```
✓ src/core/layout/__tests__/auto-placement.test.ts (12 tests)
✓ src/core/layout/__tests__/visual-output-detector.test.ts (29 tests)
✓ src/core/layout/__tests__/layout.test.ts (9 tests)

Test Files: 3 passed (3)
Tests: 50 passed (50)
```

---

## アーキテクチャ

### データフロー

```
┌─────────────────────────────────────────────────────────────────┐
│                      セル実行                                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  handleCellNotificationeration() [handlers.ts]                  │
│  - handleCellMessage(data) でセル状態更新                        │
│  - autoPlaceVisualOutput(data) で自動配置判定                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  autoPlaceVisualOutput() [handlers.ts]                          │
│  条件チェック:                                                   │
│  1. output が存在するか？                                        │
│  2. selectedLayout === "grid" か？                              │
│  3. autoLayoutEnabled === true か？                             │
│  4. セルが既にグリッドにないか？                                  │
│  5. isVisualOutput(output) === true か？                        │
└─────────────────────────────────────────────────────────────────┘
                              │ すべて満たす場合
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  addCellToGridLayout(cellId) [layout.ts]                        │
│  - グリッド未初期化なら GridLayoutPlugin.getInitialLayout() で初期化 │
│  - calculateNewCellPlacement() で位置計算                        │
│  - layoutReducer で状態更新                                      │
│  - store.set() でグローバル状態反映                               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  グリッドUI更新（React再レンダリング）                            │
└─────────────────────────────────────────────────────────────────┘
```

---

## ビジュアルアウトプット判定ロジック

### 直接判定されるMIMEタイプ

```typescript
const VISUAL_MIMETYPES = new Set([
  // 画像
  "image/png",
  "image/jpeg",
  "image/svg+xml",
  "image/gif",
  "image/tiff",
  "image/avif",
  "image/bmp",
  // 動画
  "video/mp4",
  "video/mpeg",
  // チャート（Vega系）
  "application/vnd.vegalite.v5+json",
  "application/vnd.vega.v5+json",
  "application/vnd.vegalite.v6+json",
  "application/vnd.vega.v6+json",
]);
```

### HTML内のチャート署名（text/html の場合）

```typescript
const HTML_VISUAL_SIGNATURES = [
  "plotly-graph-div",    // Plotly
  "bokeh",               // Bokeh
  "altair-viz",          // Altair（フォールバック）
  "<svg",                // SVG埋め込み
  "<canvas",             // Canvas系チャート
  "data:image/",         // インライン画像
  "echarts",             // ECharts
  "lightweight-charts",  // TradingView Lightweight Charts
  "marimo-anywidget",    // AnyWidget（mo.ui.anywidget）
];
```

### mimebundle の場合

`application/vnd.marimo+mimebundle` の場合、バンドル内のいずれかのキーが `VISUAL_MIMETYPES` に含まれていればビジュアルと判定。

---

## 自動配置アルゴリズム

### デフォルト設定

```typescript
const DEFAULT_PLACEMENT_CONFIG = {
  columns: 24,        // グリッドの総カラム数
  rowHeight: 20,      // 1行の高さ（px）
  defaultWidth: 12,   // デフォルト幅（カラム数）= グリッドの半分
  defaultHeight: 20,  // デフォルト高さ（行数）= 400px
};
```

### 配置戦略

1. **単一セル**: フル幅（24カラム）で配置
2. **複数セル**: 2列レイアウト（左右交互に12カラムずつ）
3. **奇数個の最後のセル**: フル幅で配置
4. **新規追加時**: 既存セルの最下部の下に配置

```
┌──────────────────────────────────────────────────┐
│                    単一チャート                    │
│                  (24カラム x 20行)                 │
└──────────────────────────────────────────────────┘

┌────────────────────┐ ┌────────────────────┐
│    チャート1        │ │    チャート2        │
│  (12カラム x 20行)  │ │  (12カラム x 20行)  │
└────────────────────┘ └────────────────────┘
┌────────────────────┐ ┌────────────────────┐
│    チャート3        │ │    チャート4        │
│  (12カラム x 20行)  │ │  (12カラム x 20行)  │
└────────────────────┘ └────────────────────┘
┌──────────────────────────────────────────────────┐
│    チャート5（奇数最後 = フル幅）                   │
│                  (24カラム x 20行)                 │
└──────────────────────────────────────────────────┘
```

---

## 状態管理

### LayoutState の拡張

```typescript
export interface LayoutState {
  selectedLayout: LayoutType;
  layoutData: Partial<Record<LayoutType, LayoutData>>;

  // 新規追加
  autoLayoutEnabled: boolean;        // 自動配置が有効か
  layoutWasAutoGenerated: boolean;   // レイアウトが自動生成されたか
}
```

### 初期値

```typescript
{
  selectedLayout: is3DMode ? "grid" : "vertical",
  layoutData: {},
  autoLayoutEnabled: true,           // デフォルトで有効
  layoutWasAutoGenerated: false,
}
```

---

## 公開API

### visual-output-detector.ts

```typescript
// MIMEタイプがビジュアルか判定
export function isVisualMimetype(mimetype: string): boolean;

// HTML内にチャート署名があるか判定
export function isVisualHtml(htmlContent: string): boolean;

// OutputMessage がビジュアル出力か判定
export function isVisualOutput(output: OutputMessage | null): boolean;

// ビジュアルMIMEタイプの Set
export const VISUAL_MIMETYPES: Set<string>;
```

### auto-placement.ts

```typescript
// 複数セルの初期配置を計算
export function calculateAutoPlacement(
  visualCellIds: CellId[],
  config?: PlacementConfig,
): GridCellPosition[];

// 新規セルの追加位置を計算
export function calculateNewCellPlacement(
  cellId: CellId,
  existingCells: GridCellPosition[],
  config?: PlacementConfig,
): GridCellPosition;

// デフォルト設定
export const DEFAULT_PLACEMENT_CONFIG: PlacementConfig;
```

### layout.ts

```typescript
// セルをグリッドに追加
export function addCellToGridLayout(cellId: CellId): void;

// セルがグリッドに存在するか確認
export function isCellInGrid(cellId: CellId): boolean;
```

---

## 動作確認

### テスト用ノートブック

`docs/plans/fintech1.py` - Lightweight Charts（AnyWidget）を使用したバックテストアプリ

### ブラウザコンソールログの例

```
[autoPlace] Cell setup: isVisual=false, mimetype=text/plain     # setupセル（import等）- 対象外
[autoPlace] Cell Hbol: isVisual=true, mimetype=text/html        # チャートセル - ビジュアル検出 ✅
[autoPlace] Cell Hbol: adding to grid layout                    # グリッドに追加 ✅
Grid layout not initialized, creating initial layout            # 初期化成功 ✅
[autoPlace] Cell vblA: isVisual=false, mimetype=text/plain      # run()セル（print出力）- 対象外
[autoPlace] Cell bkHC: isVisual=false, mimetype=text/plain      # reset()セル（print出力）- 対象外
```

**ポイント:**
- `text/html` の出力（チャート等）→ ビジュアルとして検出され、グリッドに配置
- `text/plain` の出力（print文等）→ 非ビジュアルとして正しくスキップ

---

## テストコマンド

```bash
# ユニットテスト実行
cd frontend && pnpm test src/core/layout/__tests__/

# 個別テスト
cd frontend && pnpm test src/core/layout/__tests__/visual-output-detector.test.ts
cd frontend && pnpm test src/core/layout/__tests__/auto-placement.test.ts
cd frontend && pnpm test src/core/layout/__tests__/layout.test.ts

# 型チェック
cd frontend && pnpm tsc --noEmit

# リントチェック
cd frontend && pnpm biome check src/core/layout/
```

---

## 関連ファイル

- `frontend/src/components/editor/renderers/grid-layout/plugin.tsx` - グリッドプラグイン定義
- `frontend/src/components/editor/renderers/grid-layout/types.ts` - グリッドレイアウト型定義
- `frontend/src/components/editor/Output.tsx` - 出力レンダラー（MIMEタイプ参照）
- `frontend/src/core/kernel/messages.ts` - OutputMessage型定義

---

## 今後の拡張ポイント

### 1. ユーザー設定での無効化

`app.config` に `auto_layout: false` を追加して無効化できるようにする。

```python
app = marimo.App(width="grid", auto_layout=False)
```

### 2. 手動編集後の自動配置停止

ユーザーがセルを手動でリサイズ/移動した場合、`autoLayoutEnabled = false` にして以降の自動配置を停止する。

### 3. 「自動整列」ボタン

グリッドコントロールに「Auto-arrange」ボタンを追加し、現在のすべてのビジュアル出力を再配置する機能。

### 4. アスペクト比対応

出力のアスペクト比を検出し、それに応じたサイズで配置する。

---

## 修正履歴

### 2026-01-27 - 機能完成

1. **layout.ts - グリッドレイアウト未初期化問題の修正**
   - `addCellToGridLayout`で`gridLayout`が`undefined`の場合に自動初期化
   - `GridLayoutPlugin.getInitialLayout([])`で空のグリッドを作成

2. **visual-output-detector.ts - AnyWidget検出追加**
   - `HTML_VISUAL_SIGNATURES`に`"marimo-anywidget"`を追加

3. **handlers.ts - 自動配置トリガー**
   - `autoPlaceVisualOutput()`関数でセル出力到着時に自動配置を判定・実行

4. **テスト追加**
   - `layout.test.ts` - 9テストケース
   - `visual-output-detector.test.ts` - 29テストケース（AnyWidget含む）
   - `auto-placement.test.ts` - 12テストケース
   - **全50テスト合格**

### 解決した問題

**問題:** グリッドレイアウトモードで、チャート（Lightweight Charts等）がサイドバーに配置されてしまう

**原因:** `layoutData.grid`が`undefined`の場合、`addCellToGridLayout()`がサイレントリターンしていた

**解決:** グリッド未初期化時に`GridLayoutPlugin.getInitialLayout([])`で自動初期化するように修正
