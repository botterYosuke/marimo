# フロントエンドフリーズ対策計画

## 問題の真の原因

`fintech1.py` のセル構造に問題がある：

```python
@app.cell
def _(AutoRefresh, bt, code):
    AutoRefresh()  # ← set_step() で毎ステップ再実行される
    chart = bt.chart(code=code)  # ← 毎回チャートを新規作成！重い！
    chart
```

**フリーズの連鎖**:

```
set_step(bt._step_index)
    ↓
AutoRefresh() に依存するセルが再実行
    ↓
bt.chart() が毎回新規作成
    ↓
重い処理が蓄積 → フリーズ
```

チャート新規作成の処理内容:
- `LightweightChartWidget()` インスタンス生成
- `df_to_lwc_data()` で全OHLCデータ変換（ループ処理）
- `df_to_lwc_volume()` で出来高変換
- `trades_to_markers()` でマーカー変換
- JS側でCDN読み込み、チャート描画

**BroadcastChannelは問題ではない**（軽量なメッセージング）

---

## 解決方針: チャートの初回作成と差分更新を分離

`LightweightChartWidget` には既に差分更新の仕組みがある:
- `last_bar` トレイトで最新バーのみ更新
- `setDirectUpdateKeys(['last_bar'])` でReact再レンダーをスキップ
- `requestAnimationFrame` でバッチ更新

### 修正案: fintech1.py のセル構造変更

**Before（問題のあるコード）**:
```python
@app.cell
def _(AutoRefresh, bt, code):
    AutoRefresh()  # 毎ステップ再実行トリガー
    chart = bt.chart(code=code)  # 毎回新規作成（重い）
    chart
```

**After（修正後）**:
```python
# セル1: チャートを一度だけ作成（AutoRefreshに依存させない）
@app.cell
def _(bt, code):
    chart_widget = bt.chart(code=code)
    chart_widget

# セル2: 差分更新のみ（軽量）
@app.cell
def _(AutoRefresh, bt, chart_widget, code):
    AutoRefresh()
    # last_bar で差分更新（チャート再作成なし）
    bt.update_chart(chart_widget, code)
```

---

## 実装タスク

### 1. BackcastPro に `update_chart()` メソッド追加

**ファイル**: `BackcastPro/src/BackcastPro/backtest.py` (440行目付近、`chart()`メソッドの後)

```python
def update_chart(self, widget: "LightweightChartWidget", code: str = None) -> None:
    """チャートを差分更新（再作成せずに最新バーのみ更新）

    Args:
        widget: 既存のチャートウィジェット
        code: 銘柄コード（省略時は最初のデータを使用）
    """
    if code is None:
        code = next(iter(self.data.keys()), None)
    if code is None:
        return

    df = self.data.get(code)
    if df is None or len(df) == 0:
        return

    # 最新バーのみ更新（高速）
    from .api.chart import get_last_bar
    widget.last_bar = get_last_bar(df)

    # マーカー更新
    from .api.chart import trades_to_markers
    widget.markers = trades_to_markers(self.closed_trades, code)
```

### 2. fintech1.py のセル構造修正

**ファイル**: `fintech1.py` (105-110行目)

チャートセルを2つに分離:

```python
# セル: チャート作成（一度だけ実行）
@app.cell
def _(bt, code):
    chart_widget = bt.chart(code=code)
    chart_widget

# セル: 差分更新（AutoRefreshで繰り返し実行）
@app.cell
def _(AutoRefresh, bt, chart_widget, code):
    AutoRefresh()
    bt.update_chart(chart_widget, code)
```

---

## 検証方法

1. `make dev` でmarimoを起動
2. 修正した `fintech1.py` を開いてバックテスト実行
3. フロントエンドがフリーズしないことを確認
4. DevTools Performance タブで確認:
   - チャート初期化は1回のみ
   - `last_bar` 更新は軽量（<5ms）

---

## 技術詳細

### LightweightChartWidget の差分更新機構

```javascript
// chart.py の _esm より抜粋

// 高頻度更新キーを設定（React 再レンダーをスキップ）
if (model.setDirectUpdateKeys) {
    model.setDirectUpdateKeys(['last_bar', 'last_bar_packed']);
}

// RAFベースのバッチ更新
model.on("change:last_bar", () => {
    pendingBar = bar;
    if (rafId === null) {
        rafId = requestAnimationFrame(flushPendingBar);
    }
});
```

この仕組みにより:
- `last_bar` の更新はReactの再レンダーをトリガーしない
- 複数の更新が同フレーム内に発生しても、最新値のみ描画
- ブラウザの描画サイクルに同期して効率的に更新
