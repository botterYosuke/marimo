# Backcast プロジェクト仕様書

> **AIにとっての "Single Source of Truth"**  
> このドキュメントは、プロジェクトの目的、要件、技術スタック、制約を集約的に定義します。

---

## 1. プロジェクトの目的・ゴール

### 1.1 プロジェクト概要

**Backcast**は、[marimo](https://marimo.io)のフロントエンドを切り出したアプリケーションです。`marimo`のApp ViewのGridモードに、インタラクティブなフィードバックを得られる**3Dモード**を新設し、Pythonコードの出力を**Dashboard状**に出力することで、Jupyterと同様にユーザーの検証・作業をサポートする世界最高峰のツールを目指します。

### 1.2 コアバリュー

- **迷わない体験**: ユーザーは迷うことなくコードを書き始めることができる
- **インタラクティブな3D可視化**: Gridモードと3Dモードのシームレスな切り替え
- **Dashboard出力**: Pythonコードの実行結果を直感的なDashboard形式で表示
- **検証・作業支援**: Jupyterライクな操作性で、データサイエンス・開発ワークフローを加速

### 1.3 成功指標

- ユーザーがコードを書き始めるまでの時間を最小化
- 3DモードとGridモードの両方で快適な操作性を実現
- Pythonコードの実行結果を視覚的に理解しやすい形式で提供

---

## 2. 対象ユーザー

### 2.1 プライマリーユーザー

- **Python開発者**: データ分析、機械学習、可視化を行う開発者
- **データサイエンティスト**: データ探索、モデリング、レポート作成を行う専門家
- **Jupyterユーザー**: 既存のJupyter環境から移行を検討しているユーザー

### 2.2 ユーザーのニーズ

- 直感的なコード編集環境
- リアルタイムでの実行結果の可視化
- 3D空間でのインタラクティブなデータ探索
- Dashboard形式での結果の整理・共有

---

## 3. 機能要件 / 非機能要件

### 3.1 機能要件

#### 3.1.1 コア機能

- **Gridモード**: セルをグリッドレイアウトで配置・編集
- **3Dモード**: セルを3D空間に配置し、インタラクティブに操作可能
- **モード切り替え**: Gridモードと3Dモードのシームレスな切り替え
- **Pythonコード実行**: セル単位でのPythonコードの実行と結果表示
- **Dashboard出力**: 実行結果をDashboard形式で整理・表示

#### 3.1.2 エディタ機能

- **CodeMirror統合**: Python、Markdown、SQLなどの言語サポート
- **リアルタイム編集**: コードのリアルタイム編集とプレビュー
- **オートコンプリート**: AI支援によるコード補完
- **LSP統合**: 言語サーバープロトコルによる高度な編集支援

#### 3.1.3 可視化機能

- **3Dレンダリング**: Three.jsによる3D空間でのセル配置と操作
- **インタラクティブ操作**: ドラッグ&ドロップ、ズーム、回転などの操作
- **CSS2D統合**: HTML/CSSコンテンツを3D空間に統合

#### 3.1.4 データ処理機能

- **データテーブル**: 大規模データの効率的な表示と操作
- **チャート・グラフ**: Plotly、Vega-Liteによる可視化
- **フォーム**: インタラクティブなフォーム要素の作成

### 3.2 非機能要件

#### 3.2.1 パフォーマンス

- **高速な起動**: アプリケーションの起動時間を最小化
- **スムーズな操作**: 60fpsを維持する3Dレンダリング
- **大規模データ対応**: 大量のセルやデータを効率的に処理

#### 3.2.2 信頼性

- **エラーハンドリング**: 適切なエラーメッセージとリカバリー
- **状態管理**: Jotaiによる一貫性のある状態管理
- **データ永続化**: セッション状態とレイアウトの保存

#### 3.2.3 ユーザビリティ

- **直感的なUI**: Radix UIによるアクセシブルなコンポーネント
- **レスポンシブデザイン**: 様々な画面サイズに対応
- **キーボードショートカット**: 効率的な操作のためのショートカット

#### 3.2.4 セキュリティ

- **入力検証**: ユーザー入力の適切な検証とサニタイゼーション
- **セキュアな通信**: WebSocket通信のセキュリティ確保

---

## 4. 技術スタック・制約

### 4.1 フロントエンド技術スタック

#### 4.1.1 コアフレームワーク

- **React 19**: UIライブラリ
- **TypeScript**: 型安全性の確保
- **Vite**: ビルドツール（rolldown-vite 7.3.0）
- **Jotai**: 状態管理

#### 4.1.2 UI・スタイリング

- **Tailwind CSS 4.1**: ユーティリティファーストのCSS
- **Radix UI**: アクセシブルなUIコンポーネント
- **Emotion**: CSS-in-JS（一部コンポーネントで使用）

#### 4.1.3 3D・可視化

- **Three.js 0.181**: 3Dレンダリングエンジン
- **Plotly.js 2.35**: インタラクティブなグラフ
- **Vega-Lite 6.3**: 宣言的な可視化
- **React Plotly.js**: React統合

#### 4.1.4 エディタ

- **CodeMirror 6**: コードエディタ
- **@marimo-team/codemirror-ai**: AI支援機能
- **@marimo-team/codemirror-languageserver**: LSP統合

#### 4.1.5 データ処理

- **@glideapps/glide-data-grid**: 高性能データテーブル
- **@tanstack/react-table**: テーブル操作
- **react-grid-layout**: グリッドレイアウト

#### 4.1.6 その他主要ライブラリ

- **Zod 4.1**: スキーマバリデーション
- **React Hook Form**: フォーム管理
- **date-fns**: 日付操作
- **lodash-es**: ユーティリティ関数

### 4.2 バックエンド技術スタック

- **Python**: サーバーサイド実行環境
- **WebSocket**: リアルタイム通信
- **PyInstaller**: サーバーのパッケージ化

### 4.3 開発環境

- **Node.js 20+**: ランタイム環境
- **pnpm 9+**: パッケージマネージャー
- **Electron**: デスクトップアプリケーション（オプション）
- **Vitest**: テストフレームワーク
- **Playwright**: E2Eテスト

### 4.4 ビルド・デプロイ

- **Vite**: フロントエンドビルド
- **electron-builder**: Electronアプリのパッケージ化
- **PyInstaller**: Pythonサーバーのパッケージ化

### 4.5 技術的制約

#### 4.5.1 必須制約

- **TypeScript厳格モード**: 型安全性を最優先
- **React 19**: 最新のReact機能を活用
- **ES2019+**: モダンなJavaScript機能を使用
- **モノレポ構造**: pnpm workspaceによるパッケージ管理

#### 4.5.2 アーキテクチャ制約

- **コンポーネント設計**: 関数型コンポーネントのみ（クラスコンポーネント禁止）
- **状態管理**: Jotaiによるアトミックな状態管理
- **スタイリング**: Tailwind CSSを優先、必要に応じてCSS Modules
- **命名規則**: 
  - ディレクトリ: ケバブケース（`components/auth-wizard`）
  - コンポーネント: パスカルケース（`DashboardMenu`）
  - ロジック: キャメルケース（`dashboardLogic`）
  - 関数・変数: キャメルケース（`isLoading`, `hasError`）

#### 4.5.3 コード品質制約

- **型安全性**: すべてのコードに適切な型定義
- **テスト**: 新機能には必ずユニットテストを追加
- **リンター**: Biomeによるコード品質チェック
- **フォーマット**: 一貫したコードフォーマット

---

## 5. 「やってはいけないこと（禁止事項）」

### 5.1 アーキテクチャ関連

#### ❌ 禁止事項

- **クラスコンポーネントの使用**: 関数型コンポーネントのみ使用
- **`useState`/`useEffect`によるローカル状態管理**: ロジックファイル（`logic`）を使用すること
- **デフォルトエクスポート**: 名前付きエクスポートのみ使用
- **グローバル状態の乱用**: Jotaiアトムを適切に設計し、不要なグローバル状態を避ける

#### ✅ 推奨事項

- 関数型プログラミングパターンの使用
- コンポーネントの合成による再利用性の向上
- DRY原則に従ったコードのモジュール化

### 5.2 UI・UX関連

#### ❌ 禁止事項

- **Radix UIの直接インポート**: `@/components/ui`のカスタムコンポーネントを使用
- **インラインスタイルの多用**: Tailwind CSSを優先
- **アクセシビリティの無視**: Radix UIコンポーネントの適切な使用

#### ✅ 推奨事項

- `@/components/ui`内の再利用可能なUIコンポーネントの開発
- Tailwind CSSによる一貫したスタイリング
- アクセシビリティを考慮したUI設計

### 5.3 コード品質関連

#### ❌ 禁止事項

- **型定義の省略**: TypeScriptの型安全性を損なう実装
- **テストの省略**: 新機能や変更には必ずテストを追加
- **コメントの過剰使用**: 自己説明的なコードを優先
- **推測による実装**: コードベースを確認せずに実装しない

#### ✅ 推奨事項

- コードベース内の実際の情報に基づいた実装
- 関連ファイルの検索・確認を必ず実施
- 既存のコードパターンとの整合性の確保

### 5.4 パフォーマンス関連

#### ❌ 禁止事項

- **不要な再レンダリング**: 適切なメモ化の実装
- **重い計算の同期的実行**: 非同期処理やWeb Workerの活用
- **大量データの同期的処理**: 仮想化やページネーションの実装

#### ✅ 推奨事項

- React Compilerによる最適化の活用
- 適切なメモ化（`useMemo`, `useCallback`）
- 仮想化ライブラリ（`react-virtuoso`）の活用

### 5.5 セキュリティ関連

#### ❌ 禁止事項

- **機密情報のログ出力**: 認証トークン、パスワードなどのログ出力禁止
- **入力検証の省略**: ユーザー入力の適切な検証とサニタイゼーション
- **XSS脆弱性**: DOM操作時の適切なサニタイゼーション（`dompurify`の使用）

#### ✅ 推奨事項

- Zodによるスキーマバリデーション
- 適切なエラーハンドリングとログレベル管理
- セキュアな通信プロトコルの使用

### 5.6 デバッグ・テスト関連

#### ❌ 禁止事項

- **Backendテストの無視**: フロントエンドの問題よりもBackendテストを優先
- **全体テストの先走り**: 問題発生時は最小単位のテストで切り分け
- **サーバー再起動の省略**: バックエンド変更後は必ずサーバー再起動

#### ✅ 推奨事項

- 3段階デバッグプロセス（Backend → Frontend → E2E）の遵守
- 問題切り分けの原則に従った段階的なテスト
- コード変更後の保存とサーバー再起動の徹底

### 5.7 ファイル操作関連

#### ❌ 禁止事項

- **ファイル内容の確認なしでの編集**: 編集前に必ず`read_file`で内容確認
- **パスの推測**: 実際に存在する構造に基づいたパス指定
- **既存パターンの無視**: 類似ファイルを参考にした実装

#### ✅ 推奨事項

- ファイル編集前の内容確認
- ワークスペースルートからの正確な相対パス指定
- 既存のコードスタイルとの整合性確保

### 5.8 コミュニケーション関連

#### ❌ 禁止事項

- **推測による回答**: 「おそらく」「推測では」といった表現の使用禁止
- **存在しない機能の参照**: コードベース内で確認できない情報の提示
- **不確実な情報の提供**: 100%確実でない情報は「確認が必要」と明示

#### ✅ 推奨事項

- コードベース内の実際の情報に基づいた回答
- 情報源の明確化（「Xファイルを確認しました」）
- 不明な点は素直に認め、ユーザーに確認を求める

---

## 6. プロジェクト構造

### 6.1 ディレクトリ構造

```
backcast/
├── frontend/              # フロントエンドソース
│   ├── src/               # ソースコード
│   │   ├── components/    # Reactコンポーネント
│   │   ├── core/          # コアロジック
│   │   │   ├── three/     # 3D関連ロジック
│   │   │   ├── cells/     # セル管理
│   │   │   ├── codemirror/# エディタ統合
│   │   │   └── ...
│   │   ├── hooks/         # カスタムフック
│   │   ├── plugins/       # プラグインシステム
│   │   ├── utils/         # ユーティリティ関数
│   │   └── ...
│   ├── public/            # 静的ファイル
│   ├── index.html         # エントリーポイントHTML
│   ├── vite.config.mts    # Vite設定
│   ├── tsconfig.json      # TypeScript設定
│   ├── tailwind.config.cjs# Tailwind CSS設定
│   └── postcss.config.cjs # PostCSS設定
├── packages/              # モノレポパッケージ
│   ├── llm-info/          # LLM情報パッケージ
│   ├── marimo-api/        # API型定義
│   ├── smart-cells/       # スマートセル
│   └── tsconfig/          # TypeScript設定
├── server/                # Pythonサーバー
│   ├── run.py             # サーバースタートアップスクリプト
│   ├── backcast.py        # ノートブックファイル
│   ├── server-manager.js  # サーバー管理（Node.js）
│   └── ...
├── electron/              # Electron設定
│   ├── main.js            # Electronメインプロセス
│   ├── preload.js         # プリロードスクリプト
│   └── utils/             # Electronユーティリティ
├── docs/                  # ドキュメント
└── ...
```

### 6.2 主要ファイル

- `frontend/src/core/edit-app.tsx`: メインアプリケーションコンポーネント
- `frontend/src/core/mode.ts`: アプリケーションモード管理（read/edit/present）
- `frontend/src/core/three/`: 3D関連のコアロジック
- `frontend/src/components/editor/renderers/`: レンダラー（Grid/3D）
  - `grid-layout/`: Gridモード用レンダラー
  - `3d-layout/`: 3Dモード専用レンダラー（`Grid3DLayoutRenderer`、`Grid3DControls`）
  - `grid-3d-renderer.tsx`: 3Dモード用グリッドレンダラー
- `frontend/vite.config.mts`: Vite設定
- `package.json`: 依存関係とスクリプト（ルート）

---

## 7. 開発ワークフロー

### 7.1 開発環境セットアップ

```powershell
# 依存関係のインストール
pnpm install

# 開発サーバーの起動
pnpm dev
```

### 7.2 ビルド

```powershell
# フロントエンドビルド
pnpm build

# サーバービルド
pnpm build:server
```

### 7.3 テスト

```powershell
# 型チェック
pnpm typecheck

# リンター
pnpm lint

# ユニットテスト（Vitest）
pnpm test src/path/to/file.test.ts
```

---

## 8. 参考情報

### 8.1 関連ドキュメント

- `.cursor/rules/anti_hallucination_rules.mdc`: ハルシネーション抑制ルール
- `.cursor/rules/`: その他の開発ルール

### 8.2 外部リソース

- [marimo](https://marimo.io/): ベースとなるプロジェクト
- [React 19](https://react.dev/): React公式ドキュメント
- [Three.js](https://threejs.org/): Three.js公式ドキュメント
- [Tailwind CSS](https://tailwindcss.com/): Tailwind CSS公式ドキュメント

---

**最終更新**: 2026年1月  
**バージョン**: 0.1.0

