---
name: JSONインポート解決プラグイン追加
overview: Rolldownが`@marimo-team/llm-info/models.json`と`@marimo-team/llm-info/providers.json`を解決できない問題を修正するため、Viteプラグインを追加してJSONファイルのインポートを明示的に処理します。
todos:
  - id: add-json-plugin
    content: vite.config.mtsにjsonImportPlugin関数を追加して、@marimo-team/llm-info/models.jsonとproviders.jsonのインポートを解決する
    status: completed
  - id: register-plugin
    content: jsonImportPluginをplugins配列に追加して有効化する
    status: completed
    dependencies:
      - add-json-plugin
---

# JSONインポート

解決プラグイン追加

## 問題

GitHub Actionsのビルドで、Rolldownが`@marimo-team/llm-info/models.json`と`@marimo-team/llm-info/providers.json`のインポートを解決できずにエラーが発生しています。JSONファイルは生成されていますが、ビルド時に解決されていません。

## 解決策

既存の`svgInlinePlugin`と同様のViteプラグインを作成し、JSONファイルのインポートを明示的に解決します。

## 実装内容

### 1. Vite設定ファイルの修正

[vite.config.mts](vite.config.mts)にJSONインポート解決プラグインを追加：

- `jsonImportPlugin`関数を作成
- `resolveId`: `@marimo-team/llm-info/models.json`と`@marimo-team/llm-info/providers.json`を解決
- `load`: JSONファイルを読み込み、ESモジュール形式でエクスポート
- プラグインを`plugins`配列に追加

### 2. 実装詳細

```typescript
const jsonImportPlugin = (): Plugin => {
  return {
    name: "json-import-plugin",
    resolveId(id) {
      if (
        id === "@marimo-team/llm-info/models.json" ||
        id === "@marimo-team/llm-info/providers.json"
      ) {
        return `\0json-import:${id}`;
      }
      return null;
    },
    load(id) {
      if (id.startsWith("\0json-import:")) {
        const jsonPath = id.replace("\0json-import:", "");
        const isModels = jsonPath === "@marimo-team/llm-info/models.json";
        const filePath = isModels
          ? path.resolve(__dirname, "./packages/llm-info/data/generated/models.json")
          : path.resolve(__dirname, "./packages/llm-info/data/generated/providers.json");
        
        try {
          const jsonContent = readFileSync(filePath, "utf-8");
          const jsonData = JSON.parse(jsonContent);
          const exportKey = isModels ? "models" : "providers";
          
          // JSONファイルの構造を確認: { "models": [...] } または { "providers": [...] }
          if (!jsonData[exportKey]) {
            throw new Error(
              `Expected key "${exportKey}" not found in ${filePath}. Found keys: ${Object.keys(jsonData).join(", ")}`
            );
          }
          
          return `export const ${exportKey} = ${JSON.stringify(jsonData[exportKey], null, 2)};`;
        } catch (error) {
          if (error instanceof Error) {
            throw new Error(
              `Failed to load JSON file ${filePath}: ${error.message}`
            );
          }
          throw error;
        }
      }
      return null;
    },
  };
};
```

### 3. 実装済みの機能

- ✅ JSONファイルの構造を確認し、適切なキー（`models`または`providers`）でエクスポート
- ✅ ファイルが存在しない場合のエラーハンドリング（try-catchで実装済み）
- ✅ JSON構造の検証（期待されるキーの存在チェック）
- ✅ 詳細なエラーメッセージ（ファイルパスと見つかったキーを表示）

### 4. 実装状況

実装は完了し、ローカルビルドで動作確認済みです。GitHub Actionsでの動作確認は次回のCI実行時に実施予定です。