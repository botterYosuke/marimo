---
name: サイドバー要素へのホイールイベント転送追加
overview: 3Dモード時、`Outputs`サイドバー要素でもホイールイベントをOrbitControlsに転送。セル内スクロールは許可し、それ以外の領域ではカメラズームに転送。
todos:
  - id: extract-wheel-handler
    content: ホイールイベントハンドラーを共通関数として抽出（createWheelHandler）
    status: pending
  - id: add-sidebar-data-attr
    content: サイドバー要素にdata-sidebar="outputs"属性を追加
    status: pending
  - id: find-sidebar-element
    content: サイドバー要素をdata-sidebar="outputs"セレクターで取得するロジックを追加
    status: pending
    dependencies:
      - add-sidebar-data-attr
  - id: add-sidebar-listener
    content: setupWheelHandler内でサイドバー要素にもホイールイベントリスナーを追加
    status: pending
    dependencies:
      - extract-wheel-handler
      - find-sidebar-element
  - id: manage-cleanup-fns
    content: 複数のイベントリスナーのクリーンアップ関数を配列で管理
    status: pending
    dependencies:
      - add-sidebar-listener
  - id: test-sidebar-wheel
    content: サイドバー上でのホイール操作がカメラズームに反映され、セル内スクロールは正常に動作することを確認
    status: pending
    dependencies:
      - manage-cleanup-fns
---

# サイドバー要

素へのホイールイベント転送追加

## 概要

3Dモード時、`Outputs`サイドバー要素（`div.flex-none flex flex-col w-[300px]...`）でも、ReactGridLayoutと同様にホイールイベントをOrbitControlsに転送する。サイドバー内のセル内スクロールは許可し、それ以外の領域ではカメラズームに転送する。

## 実装方針

1. **既存のホイールイベントハンドラーを共通化**

- ReactGridLayoutとサイドバー要素の両方で使用できる共通のハンドラー関数を作成

2. **サイドバー要素へのイベントリスナー追加**

- サイドバー要素に`data-sidebar="outputs"`属性を追加（セレクターの改善）
- サイドバー要素を取得し、ホイールイベントリスナーを追加
- セル内（`data-scrollable="true"`）では通常のスクロールを許可（`data-cell-id`のチェックは不要）
- それ以外ではホイールイベントをOrbitControlsに転送

3. **クリーンアップ関数の管理**

- 複数のイベントリスナーのクリーンアップを適切に管理

## 実装ファイル

### `src/components/editor/renderers/3d-layout/grid-3d-layout-renderer.tsx`

- ホイールイベントハンドラーを共通関数として抽出
- サイドバー要素（`Outputs`のdiv）を取得し、イベントリスナーを追加
- セル内スクロールの判定ロジックを拡張（サイドバー内のセルも考慮）

## 実装詳細

### 共通ハンドラー関数の作成

````typescript
const createWheelHandler = (sceneManager: SceneManager) => {
  return (event: WheelEvent) => {
    // イベント発生元がスクロール可能なセル内かチェック
    const target = event.target as HTMLElement;
    const scrollableCell = target.closest('[data-scrollable="true"]');
    
    if (scrollableCell) {
      // スクロール可能なセル内では通常のスクロールを許可
      return;
    }

    // デフォルトのスクロールを無効化
    event.preventDefault();

    const renderer = sceneManager.getRenderer();
    const canvas = renderer?.domElement;
    if (!canvas) {
      return;
    }

    // イベントをcanvas要素に転送
    const wheelEvent = new WheelEvent(event.type, {
      deltaX: event.deltaX,
      deltaY: event.deltaY,
      deltaZ: event.deltaZ,
      deltaMode: event.deltaMode,
      clientX: event.clientX,
      clientY: event.clientY,
      bubbles: true,
      cancelable: true,
    });

    canvas.dispatchEvent(wheelEvent);
  };
};
```

**注意**: `data-cell-id`のチェックは削除。`data-scrollable="true"`のチェックのみで十分。サイドバー内のセルは`isScrollable={false}`で固定されているため、`data-scrollable="false"`が設定され、ホイールイベントはOrbitControlsに転送される。

### サイドバー要素へのdata属性追加

```typescript
// JSX側（517行目付近）
<div 
  data-sidebar="outputs"
  className="flex-none flex flex-col w-[300px] p-2 pb-20 gap-2 overflow-auto bg-(--slate-2) border-t border-x rounded-t shadow-sm transparent-when-disconnected mx-2 mt-4"
>
```



### setupWheelHandler関数の拡張

```typescript
const setupWheelHandler = (): boolean => {
  if (isSetup) return true;

  const gridContainer = document.querySelector('.grid-3d-container');
  if (!gridContainer) {
    return false;
  }

  const gridLayoutElement = gridContainer.querySelector('.react-grid-layout') as HTMLElement;
  if (!gridLayoutElement) {
    return false;
  }

  const cleanupFns: (() => void)[] = [];
  const wheelHandler = createWheelHandler(sceneManager);

  // ReactGridLayoutにイベントリスナーを追加
  gridLayoutElement.addEventListener('wheel', wheelHandler, { passive: false });
  cleanupFns.push(() => {
    gridLayoutElement.removeEventListener('wheel', wheelHandler);
  });

  // サイドバー要素にイベントリスナーを追加
  const sidebarElement = gridContainer.querySelector('[data-sidebar="outputs"]') as HTMLElement;
  if (sidebarElement) {
    sidebarElement.addEventListener('wheel', wheelHandler, { passive: false });
    cleanupFns.push(() => {
      sidebarElement.removeEventListener('wheel', wheelHandler);
    });
  }

  cleanupFn = () => {
    cleanupFns.forEach(cleanup => cleanup());
  };
  
  isSetup = true;
  return true;
};
```



### クリーンアップ関数の管理

複数のイベントリスナーのクリーンアップを配列で管理：

```typescript
const cleanupFns: (() => void)[] = [];

// ReactGridLayoutとサイドバーの両方にイベントリスナーを追加
// ...

return () => {
  cleanupFns.forEach(cleanup => cleanup());
};
```



## 注意事項

- `data-scrollable="true"`のチェックのみを使用（`data-cell-id`のチェックは不要）

````