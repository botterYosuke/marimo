# 3Dモードで

セルタイトルバーのドラッグ機能を修正

## 現状確認

既に以下の実装が存在しています：

- `Cell3DWrapper` - タイトルバーとドラッグハンドラー
- `CellDragManager` - ドラッグ処理の管理
- `CellCSS2DService` - セルごとのCSS2DObject管理

しかし、動作に問題がある可能性があるため、以下を確認・修正します。

## 実装ファイル

### 1. CellDragManagerの修正

- `src/core/three/cell-drag-manager.ts`
- **不具合修正**: `onMouseMove()` 内で `css2DService.getCurrentScale()` を呼び出して `currentScale` を更新
- `startDrag()` で `css2DService` への参照を保存するか、`onMouseMove()` の引数として渡す
- `onMouseMove()` 内で毎回スケールを取得して `this.currentScale` を更新
- ドラッグ中の位置更新が正しく動作することを確認
- イベントリスナーのクリーンアップは既に実装されている（確認済み）

### 2. Cell3DWrapperの修正

- `src/components/editor/renderers/cell-3d-wrapper.tsx`
- **不具合修正**: `dragManager.isDraggingCell(cellId)` を使用して `dragging` クラスを条件付きで追加
- `className` 属性で `cn("cell-3d-wrapper floating-window", dragManager.isDraggingCell(cellId) && "dragging")` のように条件付きクラスを追加
- ドラッグ開始時のスケール取得は既に実装されている（確認済み）
- ボタンクリック時のドラッグ防止処理は既に実装されている（確認済み）

### 3. CellCSS2DServiceの確認

- `src/core/three/cell-css2d-service.ts`
- `getCurrentScale()` メソッドが正しく動作することを確認
- セル位置の更新が即座に反映されることを確認

### 4. スタイルの調整

- `src/components/editor/renderers/cell-3d-wrapper.css`
- ドラッグ中の視覚的フィードバックを改善
- タイトルバーのカーソルスタイルを確認

## 実装詳細

### ドラッグ処理の流れ

1. **タイトルバーでmousedown**

- `Cell3DWrapper.handleTitleBarMouseDown()` が呼ばれる
- ボタンクリックの場合はドラッグを開始しない
- 現在のセル位置とスケールを取得
- `CellDragManager.startDrag()` を呼び出し

2. **mousemove**

- `CellDragManager.onMouseMove()` が呼ばれる
- **修正**: `css2DService.getCurrentScale()` を呼び出して `currentScale` を更新（カメラ移動時のスケール変更に対応）
- スケールを考慮して位置を計算
- `requestAnimationFrame` でスムーズに更新
- `CellCSS2DService.updateCellPosition()` で位置を更新

3. **mouseup**

- `CellDragManager.onMouseUp()` が呼ばれる
- イベントリスナーを削除
- 最終位置を保存

### 修正ポイント

1. **スケールの動的更新（実装済み）**

- 問題: `CellDragManager` の `currentScale` は `startDrag()` で一度だけ設定され、ドラッグ中は更新されない
- 影響: ドラッグ中にカメラが移動してスケールが変わると、位置計算が不正確になる
- 修正: `CellDragManager.onMouseMove()` 内で、`css2DService.getCurrentScale()` を呼び出して `currentScale` を更新
- 実装箇所: `src/core/three/cell-drag-manager.ts` の `onMouseMove()` メソッド内（90-94行目）
- **実装済み**: `setCSS2DService()`メソッドも実装済み（39-41行目）

2. **視覚的フィードバック（実装済み、実装方法が異なる）**

- 問題: CSSに `.cell-3d-wrapper.dragging` は定義されているが、コンポーネントで使用されていない
- 影響: ドラッグ中の視覚的フィードバックが機能しない
- 修正: `Cell3DWrapper` でローカルstate（`isDragging`）を使用し、`dragging` クラスを条件付きで追加
- 実装箇所: `src/components/editor/renderers/cell-3d-wrapper.tsx` の `className` 属性（175-178行目）
- **実装済み**: 計画書では`dragManager.isDraggingCell(cellId)`を使用することを提案していましたが、実際の実装ではローカルstateを使用しています

3. **イベント処理の確実性**

- `preventDefault()` と `stopPropagation()` は既に適切に使用されている（確認済み）
- ボタンクリック時のドラッグ防止は既に実装されている（確認済み）

## 実装の詳細

### 修正1: CellDragManagerのスケール動的更新

**変更箇所**: `src/core/three/cell-drag-manager.ts`

1. `CellDragManager` クラスに `css2DService` への参照を追加
   ````typescript
               private css2DService?: CellCSS2DService;
               ```
            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            2. `setCSS2DService()` メソッドを追加（または `startDrag()` の引数として渡す）
               ```typescript
               setCSS2DService(service: CellCSS2DService): void {
                 this.css2DService = service;
               }
               ```
            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            3. `onMouseMove()` 内でスケールを動的に取得
               ```typescript
               private onMouseMove = (event: MouseEvent): void => {
                 // ... 既存のコード ...
                 
                 this.rafId = requestAnimationFrame(() => {
                   // ... 既存のコード ...
                   
                   // スケールを動的に取得（カメラ移動時のスケール変更に対応）
                   if (this.css2DService) {
                     this.currentScale = this.css2DService.getCurrentScale();
                   }
                   
                   const adjustedDeltaX = this.currentScale > 0 ? deltaX / this.currentScale : deltaX;
                   // ... 既存のコード ...
                 });
               };
               ```
            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            4. `Cells3DRenderer` で `setCSS2DService()` を呼び出す
               ```typescript
               dragManager.setCSS2DService(css2DService);
               ```
            
### 修正2: Cell3DWrapperの視覚的フィードバック

**変更箇所**: `src/components/editor/renderers/cell-3d-wrapper.tsx`

**実装済み（実装方法が異なる）**: 計画書では`dragManager.isDraggingCell(cellId)`を使用することを提案していましたが、実際の実装ではローカルstate（`isDragging`）を使用しています。

実装内容（78行目、175-178行目）：
```typescript
const [isDragging, setIsDragging] = useState(false);

// ...

<div
  ref={wrapperRef}
  className={cn(
    "cell-3d-wrapper floating-window",
    isDragging && "dragging"
  )}
  data-cell-wrapper-id={cellId}
>
```

この実装方法でも視覚的フィードバックは正常に機能しています。ドラッグ開始時に`setIsDragging(true)`を呼び出し、ドラッグ終了時に`setIsDragging(false)`を呼び出す実装になっています（128-141行目の`useEffect`フック）。
            
            ## 技術的な考慮事項
            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            1. **パフォーマンス**
            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - `requestAnimationFrame` を使用してスムーズに更新
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - ドラッグ中は不要な再レンダリングを避ける
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - スケール取得は `onMouseMove()` 内で毎回実行するが、`getCurrentScale()` は軽量な処理
            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            2. **座標系の変換**
            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - 画面座標（clientX, clientY）から3D空間座標への変換
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - CSS2D空間でのスケールを考慮した位置計算
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - Y軸は逆（画面の上方向がZ軸の負方向）
            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            3. **既存機能の維持**
            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - セルの編集、実行、削除などの機能を維持
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - グリッド配置アルゴリズムは初期配置のみに使用
            
            ## 確認事項
            
            ### 実装前の確認
            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            1. `CellDragManager` の `startDrag()` メソッドのシグネチャを確認
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - 現在は `startDrag(event, cellId, currentPosition, scale)` となっている
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - `css2DService` を引数として渡すか、別途 `setCSS2DService()` で設定するかを決定
            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            2. `cn` ユーティリティのインポート
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - `src/components/editor/renderers/cell-3d-wrapper.tsx` で `cn` がインポートされているか確認
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - 未インポートの場合は `@/utils/cn` からインポート
            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            3. `Cell3DWrapper` の再レンダリング
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - `dragManager.isDraggingCell(cellId)` を使用する場合、ドラッグ状態の変化を検知する必要がある
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - `CellDragManager` に状態変更のコールバックを追加するか、`useState` で状態を管理するかを検討
            
            ### 実装後の確認
            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            1. ドラッグ機能の動作確認
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - タイトルバーをドラッグしてセルが移動することを確認
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - ドラッグ中に `dragging` クラスが追加され、視覚的フィードバックが機能することを確認
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - ドラッグ中にカメラを移動しても、位置計算が正確であることを確認
            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            2. ボタンクリック時の動作確認
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - タイトルバーのボタン（将来的に追加される可能性がある）をクリックしてもドラッグが開始されないことを確認
            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            3. パフォーマンス確認
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - ドラッグ中の動作がスムーズであることを確認
            
         
      
   
   ````