# 3Dモードのグリッド設定反映テストの作成（修正版）

## 実装状況

**実装済み**: この計画書で提案されていた内容は既に実装されています。

1. **実装済みの内容**:

- `edit-app.tsx`の450-455行目で、`convertGrid3DConfigToLayout`関数を使用して`grid3DConfigAtom`から`layout`を生成しています
- `Grid3DLayoutRenderer`は`grid3DConfigAtom`（`Grid3DConfig`型）に同期するよう実装されています
- テストファイル（`grid-3d-config-integration.test.tsx`）も作成済みです

2. **実装方法**:

- `Grid3DRenderer`に渡す`layout`は、`grid3DConfigAtom`から取得した`Grid3DConfig`を`convertGrid3DConfigToLayout`関数で`GridLayout`に変換して生成しています
- セル配置情報（`cells`、`scrollableCells`、`cellSide`）は`layoutState.layoutData.grid`から取得し、設定値（`columns`、`rowHeight`、`maxWidth`、`bordered`）は`grid3DConfig`から取得してマージしています

## 実装方針（修正版）

### 1. `edit-app.tsx`の修正

`Grid3DRenderer`に渡す`layout`を、`layoutState.layoutData.grid`からではなく、`grid3DConfigAtom`から生成するように変更します。実装内容：

- `grid3DConfigAtom`から`Grid3DConfig`を取得
- `Grid3DConfig`を`GridLayout`に変換するヘルパー関数を作成
- セル配置情報（`cells`、`scrollableCells`、`cellSide`）は`layoutState.layoutData.grid`から取得し、設定値（`columns`、`rowHeight`、`maxWidth`、`bordered`）は`grid3DConfig`から取得してマージ
- `setLayout`コールバックでは、セル配置情報のみを`layoutState.layoutData.grid`に保存（設定値は`grid3DConfigAtom`に保存されるため）

### 2. 統合テストの作成（修正版）

新しいテストファイル `src/components/editor/renderers/3d-layout/__tests__/grid-3d-config-integration.test.tsx` を作成します。

#### テストの構成

1. **セットアップ**

- Jotai ProviderとStoreのセットアップ
- 必要なモックの設定（Three.js、CSS2DRenderer関連）
- `Grid3DControls`と`Grid3DLayoutRenderer`をレンダリング

2. **テストケース**

- **Max Width (px)の反映**
    - `Grid3DControls`でMax Widthを変更
    - `grid3DConfigAtom`が更新されることを確認
    - `Grid3DLayoutRenderer`に渡される`layout` propが更新されることを確認
    - 実際のDOM要素の`maxWidth`スタイルが反映されていることを確認
- **Columnsの反映**
    - `Grid3DControls`でColumnsを変更
    - `Grid3DLayoutRenderer`の`ReactGridLayout`の`cols` propが更新されることを確認
- **Row Height (px)の反映**
    - `Grid3DControls`でRow Heightを変更
    - `Grid3DLayoutRenderer`の`ReactGridLayout`の`rowHeight` propが更新されることを確認
- **Borderedの反映**
    - `Grid3DControls`でBorderedをトグル
    - `Grid3DLayoutRenderer`の`layout.bordered`が更新されることを確認
    - DOM要素の`grid-bordered`クラスが適用/削除されることを確認

#### テスト実装の詳細

- **テストライブラリ**: Vitest + React Testing Library
- **モック**: Three.js、SceneManager、CellCSS2DServiceをモック
- **参照**: 既存のテストファイル（`grid-3d-layout-renderer.test.tsx`、`edit-app-3d-controls.test.tsx`）のパターンに従う

## 実装ファイル

- **修正**: `src/core/edit-app.tsx`（`Grid3DRenderer`に渡す`layout`の生成ロジックを変更）
- **新規作成**: `src/components/editor/renderers/3d-layout/__tests__/grid-3d-config-integration.test.tsx`（既存のテストファイルを修正）

## テスト実行コマンド

````powershell
pnpm test src/components/editor/renderers/3d-layout/__tests__/grid-3d-config-integration.test.tsx
```





````