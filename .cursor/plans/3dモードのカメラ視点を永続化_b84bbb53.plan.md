# 3Dモードのカ

メラ視点を永続化

## 問題

現在、3Dモードのカメラ位置とOrbitControlsのtarget（カメラが向いている方向）は初期化時に固定値に設定されており、ユーザーがカメラを移動しても、3Dモードを切り替えると視点がリセットされてしまいます。

## 解決策

カメラの位置（position）とOrbitControlsのtargetをJotaiのatomで管理し、LocalStorageに永続化します。

## 実装手順

### 1. カメラ視点情報を管理するatomを作成

[src/core/three/cell-3d-view.ts](src/core/three/cell-3d-view.ts)を新規作成し、以下を実装：

- `Cell3DViewState`型を定義（`{position: {x: number, y: number, z: number}, target: {x: number, y: number, z: number}}`）
- LocalStorageキー名を定義：`"marimo:3d:cameraView:v1"`（既存パターンに合わせる）
- `cell3DViewAtom`を作成（`Cell3DViewState | null`）
- `atomWithStorage`と`jotaiJsonStorage`を使ってLocalStorageに永続化（既存パターンに合わせる）

### 2. SceneManagerにカメラ視点を設定するメソッドを追加

[src/core/three/scene-manager.ts](src/core/three/scene-manager.ts)を修正：

- `setCameraView(position: THREE.Vector3, target: THREE.Vector3): void`メソッドを追加
- カメラとcontrolsが初期化済みかチェック
- カメラの位置を設定（`camera.position.copy(position)`）
- OrbitControlsのtargetを設定（`controls.target.copy(target)`）
- `controls.update()`を呼び出してコントロールを更新
- `markNeedsRender()`を呼び出してレンダリングをマーク

### 3. edit-app.tsxで視点の復元・保存を実装

[src/core/edit-app.tsx](src/core/edit-app.tsx)を修正：

- `cell3DViewAtom`をインポート（`useAtomValue`と`useSetAtom`を使用）
- **視点の復元**：別の`useEffect`で、`is3DInitialized`が`true`になった後に実行
- `sceneManagerRef.current`が存在することを確認
- atomから視点情報を取得
- 保存された視点があれば、`sceneManager.setCameraView()`で設定
- 保存された視点がなければ、デフォルト値のまま（既存動作）
- **視点の保存**：3D初期化の`useEffect`内で、OrbitControlsの`end`イベントリスナーを追加
- `change`ではなく`end`イベントを使用（操作終了時のみ保存してパフォーマンスを向上）
- カメラ位置（`camera.position`）とtarget（`controls.target`）を取得
- atomに保存（THREE.Vector3を`{x, y, z}`形式に変換）
- クリーンアップ時にイベントリスナーを削除

## 技術的な詳細

### データ構造

- 保存形式：`{position: {x: number, y: number, z: number}, target: {x: number, y: number, z: number}} | null`
- シリアライズ形式：JSON（`jotaiJsonStorage`を使用、直接JSON化可能な構造のため特別な変換は不要）

### OrbitControlsのtarget

OrbitControlsは`target`プロパティを持っており、カメラが向いている方向（注視点）を管理しています。カメラの位置とtargetの両方を保存することで、完全な視点情報を復元できます。

### 初期値

保存された視点がない場合は、デフォルト値を使用します：

- `position: (0, 1200, 0)` - SceneManagerの`initialize`メソッド（45行目）で設定される初期位置
- `target: (0, 0, 0)` - OrbitControlsのtargetの初期値（`camera.lookAt(0, 0, 0)`に対応）

### パフォーマンス考慮事項

- OrbitControlsの`change`イベントは操作中の各フレームで頻繁に発火するため、`end`イベント（操作終了時のみ）を使用して保存頻度を抑制
- これにより、LocalStorageへの書き込み回数を最小限に抑え、パフォーマンスを向上

### 既存コードへの影響

- SceneManagerに新規メソッド（`setCameraView`）を追加するのみ（既存の動作に影響なし）
- edit-app.tsxの3D初期化処理に視点の復元・保存を追加