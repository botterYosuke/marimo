# 3Dモードのセルタイトルバーに実行ボタン群を追加

## 概要

`src/components/editor/renderers/cell-3d-wrapper.tsx`のタイトルバー（`.titlebar-buttons`）に、実行ボタン群と閉じるボタンを追加します。これにより、3Dモードで実行ボタン群がタイトルバーに隠れる問題を解決します。

## 実装内容

### 1. 必要なインポートの追加

[src/components/editor/renderers/cell-3d-wrapper.tsx](src/components/editor/renderers/cell-3d-wrapper.tsx)に以下をインポート：

- `useCellRuntime`, `useCellHandle` from `@/core/cells/cells`
- `useRunCell` from `@/components/editor/cell/useRunCells`
- `useDeleteCellCallback` from `@/components/editor/cell/useDeleteCell`
- `useAtomValue` from `jotai`
- `connectionAtom` from `@/core/network/connection`
- `RunButton` from `@/components/editor/cell/RunButton`
- `StopButton` from `@/components/editor/cell/StopButton`
- `CellActionsDropdown` from `@/components/editor/cell/cell-actions`
- `isOutputEmpty` from `@/core/cells/outputs`
- `XIcon` from `lucide-react`

### 2. コンポーネント内でのデータ取得

`Cell3DWrapper`コンポーネント内で、以下のhooksを使用して必要な情報を取得：

- `useCellRuntime(cellId)` - セルの実行状態（`status`, `output`, `consoleOutputs`など）
- `useCellData(cellId)` - セルのデータ（`edited`, `config`, `name`など）※既に使用中
- `useRunCell(cellId)` - セル実行関数
- `useDeleteCellCallback()` - セル削除関数（`deleteCell({ cellId })`という形式で使用）
- `useCellHandle(cellId)` - エディタビューの参照を取得（atomの値を返す）
- `useAtomValue(connectionAtom)` - 接続状態を取得

### 3. タイトルバーにボタン群を追加

[src/components/editor/renderers/cell-3d-wrapper.tsx](src/components/editor/renderers/cell-3d-wrapper.tsx)の155-157行目の`.titlebar-buttons`内に以下を追加：

1. **RunButton** - `edited`, `status`, `needsRun`, `connectionState`, `config`, `onClick` propsを渡す
2. **StopButton** - `status`, `connectionState` propsを渡す
3. **CellActionsDropdown** - `cellId`, `status`, `getEditorView`, `name`, `config`, `hasOutput`, `hasConsoleOutput` propsを渡す（childrenとしてMoreHorizontalIconボタンを渡す）
4. **閉じるボタン（X）** - `XIcon`を使用し、`onClick`で`deleteCell({ cellId })`を呼び出す

### 4. スタイルの適用

ボタンには既存の`.titlebar-btn`クラスを使用し、閉じるボタンには`.titlebar-btn.close`クラスを適用（[src/components/editor/renderers/cell-3d-wrapper.css](src/components/editor/renderers/cell-3d-wrapper.css)の89-92行目で既に定義済み）。RunButton、StopButton、CellActionsDropdownは通常のToolbarItemコンポーネントを使用しているため、タイトルバー内では`.titlebar-btn`スタイルを適用する必要がある場合があります。必要に応じて、CSSで`.titlebar-buttons .toolbar-item`や`.titlebar-buttons button`のスタイルを調整します。

### 5. ドラッグ機能の維持

既存の`handleTitleBarMouseDown`関数（64-88行目）で、ボタンクリック時にドラッグが開始されないようにする処理が既に実装されています（67-69行目）。このため、追加するボタンも`.titlebar-btn`クラスを使用することで、既存のロジックで正しく処理されます。

### 6. 実装の詳細

- `disabledOrAncestorDisabled`の計算: `cellData.config.disabled || cellRuntime.status === "disabled-transitively"`
- `needsRun`の計算: `cellData.edited || cellRuntime.interrupted || (cellRuntime.staleInputs && !disabledOrAncestorDisabled)`
- `hasOutput`: `!isOutputEmpty(cellRuntime.output)`
- `hasConsoleOutput`: `cellRuntime.consoleOutputs.length > 0`
- `getEditorView`: `useCellHandle(cellId)`から取得したcellHandleを使用してエディタビューを返すコールバック関数を作成。実装例：
  ````typescript
        const cellHandle = useCellHandle(cellId);
        const getEditorView = useCallback(() => {
          return cellHandle.current?.editorView ?? null;
        }, []);
    ```
  
  
  注意: `cellHandle`はatomの値のため、`useCallback`の依存配列には含めない（空配列を使用）
  
    - 閉じるボタンの実装:
    ```typescript
        const deleteCell = useDeleteCellCallback();
        // 使用時
        <button className="titlebar-btn close" onClick={() => deleteCell({ cellId })}>
          <XIcon />
        </button>
    ```
  
  
  
  
  ## 実装時の推奨順序
  
    1. 必要なインポートを追加
    2. hooksでデータ取得（`useCellRuntime`、`useRunCell`、`useDeleteCellCallback`、`useCellHandle`、`useAtomValue(connectionAtom)`）
    3. `disabledOrAncestorDisabled`、`needsRun`、`hasOutput`、`hasConsoleOutput`、`getEditorView`を計算
    4. タイトルバーにボタンを追加（順番：RunButton → StopButton → CellActionsDropdown → 閉じるボタン）
    5. スタイルを確認・調整（ボタンのサイズ、アイコンの配置、ホバー時のスタイルなど）
    6. 動作確認（ドラッグ機能、ボタンクリック、セル削除など）
  
  ## 注意点
  
    - 3Dモード専用の実装のため、通常モードには影響しない
    - 既存のセル内の実行ボタン群は非表示にする必要はない（タイトルバーに追加するだけ）
    - `RunButton`、`StopButton`、`CellActionsDropdown`は`ToolbarItem`コンポーネントを使用しているため、タイトルバー内での見た目を統一するには追加のCSS調整が必要になる可能性があります（実装後に確認）
    - ボタンのサイズが`.titlebar-btn`の28x28pxと合うか
  
  ````