---
name: JSONインポートプラグインの実行順序修正
overview: Viteの標準JSONローダーがカスタムプラグインより先に処理されることで発生しているビルドエラーを修正するため、プラグインの実行順序を調整し、package.jsonのexports設定を変更しました。
todos:
  - id: add-enforce-option
    content: "jsonImportPluginに`enforce: 'pre'`オプションを追加して、標準のJSONローダーより先に実行されるようにする"
    status: completed
  - id: add-file-existence-check
    content: load関数でファイルの存在確認（existsSync）を追加する
    status: completed
    dependencies:
      - add-enforce-option
  - id: add-empty-file-check
    content: load関数で空ファイルのチェックを追加する
    status: completed
    dependencies:
      - add-file-existence-check
  - id: update-imports
    content: node:fsからexistsSyncをインポートするように修正する
    status: completed
    dependencies:
      - add-empty-file-check
  - id: update-package-json-exports
    content: "`packages/llm-info/package.json`の`exports`から`.json`キーを削除し、`.ts`のみを参照するように変更する"
    status: completed
  - id: update-import-paths
    content: インポートパスを`.json`から`.ts`に変更する（`src/core/ai/model-registry.ts`、`src/core/ai/__tests__/model-registry.test.ts`）
    status: completed
    dependencies:
      - update-package-json-exports
  - id: remove-debug-logs
    content: デバッグログを削除する
    status: completed
    dependencies:
      - update-import-paths
---

# JSONインポートプラグインの実行順序修正

## 問題

GitHub Actionsのビルドで、`builtin:vite-json`プラグインが「expected value at line 1 column 1」というエラーを出していました。これは、rolldown-viteが`package.json`の`exports`で`.json`キーを見て、実際の`.json`ファイルを探そうとしていたためです。

## 根本原因

`packages/llm-info/package.json`の`exports`で`.json`キーが使われており、rolldown-viteがこのキーを見て実際の`.json`ファイルを探そうとしていました。しかし、実際には`.ts`ファイルのみが存在し、`.json`ファイルは生成されていませんでした。

## 解決策

1. **package.jsonのexports設定を変更**: `.json`キーを削除し、`.ts`のみを参照するように変更
2. **インポートパスの変更**: すべてのインポートパスを`.json`から`.ts`に変更
3. **プラグインの実行順序を調整**: `enforce: 'pre'`を追加して、標準のJSONローダーより先に実行されるようにする（既に実装済み）
4. **エラーハンドリングの改善**: ファイルが存在しない場合や空の場合のチェックを追加（既に実装済み）

## 実装内容

### 1. packages/llm-info/package.jsonの修正

`exports`から`.json`キーを削除し、`.ts`のみを参照するように変更：

```json
{
  "exports": {
    ".": "./src/index.ts",
    "./icons/*": "./icons/*",
    "./models.ts": "./data/generated/models.ts",
    "./providers.ts": "./data/generated/providers.ts"
  }
}
```

**変更前:**

```json
{
  "exports": {
    "./models.json": {
      "import": "./data/generated/models.ts",
      "types": "./data/generated/models.ts"
    },
    "./providers.json": {
      "import": "./data/generated/providers.ts",
      "types": "./data/generated/providers.ts"
    }
  }
}
```

### 2. インポートパスの変更

#### src/core/ai/model-registry.ts

```typescript
// 変更前
import { models } from "@marimo-team/llm-info/models.json";
import { providers } from "@marimo-team/llm-info/providers.json";

// 変更後
import { models } from "@marimo-team/llm-info/models.ts";
import { providers } from "@marimo-team/llm-info/providers.ts";
```

#### src/core/ai/**tests**/model-registry.test.ts

```typescript
// 変更前
vi.mock("@marimo-team/llm-info/models.json", () => {

// 変更後
vi.mock("@marimo-team/llm-info/models.ts", () => {
```

### 3. vite.config.mtsの修正（既に実装済み）

`jsonImportPlugin`関数に以下を追加：

- `enforce: 'pre'`を追加してプラグインの実行順序を最優先にする
- ファイルが存在しない場合のエラーハンドリングを改善
- ファイルが空の場合のチェックを追加
- `.ts`ファイルのサポートを追加
```typescript
const jsonImportPlugin = (): Plugin => {
  const modelsJsonPath = path.resolve(__dirname, "./packages/llm-info/data/generated/models.json");
  const providersJsonPath = path.resolve(__dirname, "./packages/llm-info/data/generated/providers.json");
  const modelsTsPath = path.resolve(__dirname, "./packages/llm-info/data/generated/models.ts");
  const providersTsPath = path.resolve(__dirname, "./packages/llm-info/data/generated/providers.ts");
  
  return {
    name: "json-import-plugin",
    enforce: "pre", // 標準のJSONローダーより先に実行
    resolveId(id) {
      if (
        id === "@marimo-team/llm-info/models.json" ||
        id === "@marimo-team/llm-info/providers.json"
      ) {
        return `\0json-import:${id}`;
      }
      return null;
    },
    load(id) {
      // 仮想モジュールIDまたは実際のファイルパスの両方を処理
      let filePath: string | null = null;
      let isModels: boolean | null = null;
      
      if (id.startsWith("\0json-import:")) {
        const jsonPath = id.replace("\0json-import:", "");
        // .tsファイルを優先的に使用
        if (jsonPath === "@marimo-team/llm-info/models.json" || jsonPath === modelsJsonPath || jsonPath === modelsTsPath) {
          filePath = existsSync(modelsTsPath) ? modelsTsPath : modelsJsonPath;
          isModels = true;
        } else if (jsonPath === "@marimo-team/llm-info/providers.json" || jsonPath === providersJsonPath || jsonPath === providersTsPath) {
          filePath = existsSync(providersTsPath) ? providersTsPath : providersJsonPath;
          isModels = false;
        }
      }
      
      if (filePath === null || isModels === null) {
        return null;
      }
        
      try {
        // ファイルの存在確認
        const fileExists = existsSync(filePath);
        if (!fileExists) {
          throw new Error(`File does not exist: ${filePath}`);
        }
        
        const fileContent = readFileSync(filePath, "utf-8");
        const isEmpty = !fileContent.trim();
        
        // 空ファイルのチェック
        if (isEmpty) {
          throw new Error(`File is empty: ${filePath}`);
        }
        
        // .tsファイルの場合は、そのまま返す
        if (filePath.endsWith('.ts')) {
          return fileContent;
        }
        
        // JSONファイルの場合は、従来通り処理
        const jsonData = JSON.parse(fileContent);
        const exportKey = isModels ? "models" : "providers";
        
        if (!jsonData[exportKey]) {
          throw new Error(
            `Expected key "${exportKey}" not found in ${filePath}. Found keys: ${Object.keys(jsonData).join(", ")}`
          );
        }
        
        const result = `export const ${exportKey} = ${JSON.stringify(jsonData[exportKey], null, 2)};`;
        return result;
      } catch (error) {
        if (error instanceof Error) {
          throw new Error(
            `Failed to load JSON file ${filePath}: ${error.message}`
          );
        }
        throw error;
      }
    },
    transform(code, id) {
      // 標準のJSONローダーが処理しようとするのを防ぐ
      if (
        id === "@marimo-team/llm-info/models.json" ||
        id === "@marimo-team/llm-info/providers.json" ||
        id === modelsJsonPath ||
        id === providersJsonPath ||
        id === modelsTsPath ||
        id === providersTsPath ||
        id.startsWith("\0json-import:")
      ) {
        return null;
      }
      return null;
    },
  };
};
```


### 4. 必要なインポートの追加

`existsSync`を使用するため、`node:fs`からインポートを追加：

```typescript
import { existsSync, readFileSync } from "node:fs";
```

## 作業記録

### 2026-01-XX: 問題の特定とデバッグ

1. **初期調査**: GitHub Actionsのビルドエラーを確認

   - エラー: `[builtin:vite-json] Error: expected value at line 1 column 1`
   - 原因: rolldown-viteが`.json`ファイルを探そうとしている

2. **デバッグログの追加**: `vite.config.mts`にデバッグログを追加して、プラグインの実行フローを確認

   - `resolveId`、`load`、`transform`フックにログを追加
   - ログから、カスタムプラグインは正常に動作しているが、`builtin:vite-json`が別のパスで`.json`ファイルを処理しようとしていることを確認

3. **根本原因の特定**: `package.json`の`exports`で`.json`キーが使われており、rolldown-viteがこのキーを見て実際の`.json`ファイルを探そうとしていることを確認

### 2026-01-XX: 修正の実装

1. **package.jsonの修正**: `packages/llm-info/package.json`の`exports`から`.json`キーを削除し、`.ts`のみを参照するように変更

2. **インポートパスの変更**: 

   - `src/core/ai/model-registry.ts`: インポートパスを`.json`から`.ts`に変更
   - `src/core/ai/__tests__/model-registry.test.ts`: モックのインポートパスを`.json`から`.ts`に変更

3. **ビルドの確認**: ビルドが成功することを確認

4. **デバッグログの削除**: `vite.config.mts`からすべてのデバッグログを削除

## 結果

- ✅ ビルドエラーが解消されました
- ✅ `package.json`の`exports`設定が適切に変更されました
- ✅ すべてのインポートパスが`.ts`に統一されました
- ✅ プラグインの実行順序が適切に設定されました
- ✅ エラーハンドリングが改善されました

## 学んだこと

1. **package.jsonのexports設定**: `.json`キーを使うと、rolldown-viteが実際の`.json`ファイルを探そうとするため、`.ts`ファイルのみを参照する場合は`.ts`キーを使うべき
2. **プラグインの実行順序**: `enforce: 'pre'`を使うことで、標準のプラグインより先に実行できる
3. **デバッグログの重要性**: 問題の根本原因を特定するために、デバッグログが非常に有用だった