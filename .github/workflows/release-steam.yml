name: Release Electron App

on:
  push:
    branches:
      - sasa/steam
  workflow_dispatch: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel if another build is in progress

permissions:
  contents: write  # Required for creating releases
  id-token: write  # Required for OIDC

env:
  TURBO_TEAM: marimo

jobs:
  # Build and release Electron app for Windows, macOS, and Linux
  build_windows:
    name: ðŸªŸ Build Windows
    runs-on: windows-latest

    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âŽ” Setup pnpm
        uses: pnpm/action-setup@v4

      - name: âŽ” Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: '**/pnpm-lock.yaml'

      - name: ðŸ“¥ Install Node.js dependencies
        run: pnpm install --frozen-lockfile --ignore-scripts

      - name: ðŸ“¦ Build frontend
        uses: ./.github/actions/build-frontend
        with:
          turbo-token: ${{ secrets.TURBO_TOKEN }}
          codecov-token: ${{ secrets.CODECOV_TOKEN }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: ðŸ”¨ Get version
        id: get_version
        shell: pwsh
        run: |
          $version = uv version --short
          echo "marimo_version=$version" >> $env:GITHUB_OUTPUT
          echo "MARIMO_VERSION=$version" >> $env:GITHUB_ENV

      - name: ðŸ“¦ Create virtual environment
        shell: pwsh
        run: uv venv

      - name: ðŸ“¦ Install Python dependencies (electron)
        shell: pwsh
        run: |
          . .venv/Scripts/Activate.ps1
          uv pip install -e ".[electron]"

      - name: ðŸ”¨ Build Python executable (PyInstaller)
        shell: pwsh
        working-directory: ${{ github.workspace }}
        run: |
          # Ensure we're in the project root and marimo.spec exists
          if (-not (Test-Path "marimo.spec")) {
            Write-Host "âŒ marimo.spec not found in current directory: $(Get-Location)"
            Get-ChildItem -Name | Select-Object -First 10
            exit 1
          }
          Write-Host "âœ… Building from: $(Get-Location)"
          uv run pyinstaller --clean --noconfirm marimo.spec

      - name: ðŸ“¦ Verify Python executable
        shell: pwsh
        run: |
          if (Test-Path "dist\marimo-server.exe") {
            Write-Host "âœ… Python executable built successfully"
          } else {
            Write-Host "âŒ Python executable not found"
            exit 1
          }

      - name: ðŸ“¦ Update package.json version
        working-directory: frontend
        run: |
          npm version ${{ env.MARIMO_VERSION }} --no-git-tag-version

      - name: ðŸ“¦ Build Electron app
        run: pnpm exec electron-builder --win --x64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¤ Upload Windows artifacts (Steam)
        uses: actions/upload-artifact@v4
        with:
          name: steam-windows-${{ env.MARIMO_VERSION }}
          path: dist-electron/win-unpacked/
          retention-days: 7

  build_macos:
    name: ðŸŽ Build macOS
    runs-on: macos-latest

    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âŽ” Setup pnpm
        uses: pnpm/action-setup@v4

      - name: âŽ” Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: '**/pnpm-lock.yaml'

      - name: ðŸ“¥ Install Node.js dependencies
        run: pnpm install --frozen-lockfile --ignore-scripts

      - name: ðŸ“¦ Build frontend
        uses: ./.github/actions/build-frontend
        with:
          turbo-token: ${{ secrets.TURBO_TOKEN }}
          codecov-token: ${{ secrets.CODECOV_TOKEN }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: ðŸ”¨ Get version
        id: get_version
        run: |
          version=$(uv version --short)
          echo "marimo_version=$version" >> $GITHUB_OUTPUT
          echo "MARIMO_VERSION=$version" >> $GITHUB_ENV

      - name: ðŸ“¦ Create virtual environment
        run: uv venv

      - name: ðŸ“¦ Install Python dependencies (electron)
        run: |
          source .venv/bin/activate
          uv pip install -e ".[electron]"

      - name: ðŸ”¨ Build Python executable (PyInstaller)
        working-directory: ${{ github.workspace }}
        run: |
          # Ensure we're in the project root and marimo.spec exists
          echo "Current directory: $(pwd)"
          echo "Checking for marimo.spec..."

          # Check if file exists and is tracked in git
          if [ ! -f "marimo.spec" ]; then
            echo "âŒ marimo.spec not found in filesystem"
            echo "Checking git status..."
            git ls-files | grep -i "marimo.spec" || echo "marimo.spec not tracked in git"
            echo "Files in root directory:"
            ls -la *.spec 2>/dev/null || echo "No .spec files found"
            exit 1
          fi

          echo "âœ… Found marimo.spec at: $(pwd)/marimo.spec"
          echo "Building Python executable..."
          uv run pyinstaller --clean --noconfirm marimo.spec

      - name: ðŸ“¦ Verify Python executable
        run: |
          if [ -f "dist/marimo-server" ]; then
            echo "âœ… Python executable built successfully"
          else
            echo "âŒ Python executable not found"
            exit 1
          fi

      - name: ðŸ“¦ Update package.json version
        working-directory: frontend
        run: |
          npm version ${{ env.MARIMO_VERSION }} --no-git-tag-version

      - name: ðŸ“¦ Build Electron app
        run: pnpm exec electron-builder --mac --x64 --arm64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false  # Skip code signing for now

      - name: ðŸ“¤ Upload macOS artifacts (Steam)
        uses: actions/upload-artifact@v4
        with:
          name: steam-macos-${{ env.MARIMO_VERSION }}
          path: dist-electron/mac/
          retention-days: 7

  build_linux:
    name: ðŸ§ Build Linux
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âŽ” Setup pnpm
        uses: pnpm/action-setup@v4

      - name: âŽ” Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: '**/pnpm-lock.yaml'

      - name: ðŸ“¥ Install Node.js dependencies
        run: pnpm install --frozen-lockfile --ignore-scripts

      - name: ðŸ“¦ Build frontend
        uses: ./.github/actions/build-frontend
        with:
          turbo-token: ${{ secrets.TURBO_TOKEN }}
          codecov-token: ${{ secrets.CODECOV_TOKEN }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: ðŸ”¨ Get version
        id: get_version
        run: |
          version=$(uv version --short)
          echo "marimo_version=$version" >> $GITHUB_OUTPUT
          echo "MARIMO_VERSION=$version" >> $GITHUB_ENV

      - name: ðŸ“¦ Create virtual environment
        run: uv venv

      - name: ðŸ“¦ Install Python dependencies (electron)
        run: |
          source .venv/bin/activate
          uv pip install -e ".[electron]"

      - name: ðŸ”¨ Build Python executable (PyInstaller)
        working-directory: ${{ github.workspace }}
        run: |
          # Ensure we're in the project root and marimo.spec exists
          echo "Current directory: $(pwd)"
          echo "Checking for marimo.spec..."

          # Check if file exists and is tracked in git
          if [ ! -f "marimo.spec" ]; then
            echo "âŒ marimo.spec not found in filesystem"
            echo "Checking git status..."
            git ls-files | grep -i "marimo.spec" || echo "marimo.spec not tracked in git"
            echo "Files in root directory:"
            ls -la *.spec 2>/dev/null || echo "No .spec files found"
            exit 1
          fi

          echo "âœ… Found marimo.spec at: $(pwd)/marimo.spec"
          echo "Building Python executable..."
          uv run pyinstaller --clean --noconfirm marimo.spec

      - name: ðŸ“¦ Verify Python executable
        run: |
          if [ -f "dist/marimo-server" ]; then
            echo "âœ… Python executable built successfully"
          else
            echo "âŒ Python executable not found"
            exit 1
          fi

      - name: ðŸ“¦ Update package.json version
        working-directory: frontend
        run: |
          npm version ${{ env.MARIMO_VERSION }} --no-git-tag-version

      - name: ðŸ“¦ Build Electron app
        run: pnpm exec electron-builder --linux --x64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¤ Upload Linux artifacts (Steam)
        uses: actions/upload-artifact@v4
        with:
          name: steam-linux-${{ env.MARIMO_VERSION }}
          path: dist-electron/linux-unpacked/
          retention-days: 7

  # Deploy to Steam
  deploy_steam:
    name: ðŸš‚ Deploy to Steam
    needs: [build_windows, build_macos, build_linux]
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: ðŸ”¨ Get version
        id: get_version
        run: |
          version=$(uv version --short)
          echo "marimo_version=$version" >> $GITHUB_OUTPUT

      - name: ðŸ“¥ Download Windows build
        uses: actions/download-artifact@v4
        with:
          name: steam-windows-${{ steps.get_version.outputs.marimo_version }}
          path: dist-electron/win-unpacked/

      - name: ðŸ“¥ Download macOS build
        uses: actions/download-artifact@v4
        with:
          name: steam-macos-${{ steps.get_version.outputs.marimo_version }}
          path: dist-electron/mac/

      - name: ðŸ“¥ Download Linux build
        uses: actions/download-artifact@v4
        with:
          name: steam-linux-${{ steps.get_version.outputs.marimo_version }}
          path: dist-electron/linux-unpacked/

      - name: ðŸš‚ Deploy to Steam
        uses: game-ci/steam-deploy@v3
        with:
          username: ${{ secrets.STEAM_USERNAME }}
          configVdf: ${{ secrets.STEAM_CONFIG_VDF }}
          appId: 4228740
          buildDescription: "v${{ steps.get_version.outputs.marimo_version }}"
          rootPath: steam/vdf
          depot1Path: ../../dist-electron/win-unpacked
          depot2Path: ../../dist-electron/mac
          depot3Path: ../../dist-electron/linux-unpacked
